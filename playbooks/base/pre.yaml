- hosts: localhost
  roles:
    - role: emit-job-header
      zuul_log_path_shard_build: true
    - log-inventory

- hosts: all
  tasks:
    - include_role:
        name: start-zuul-console

    - block:
        # A regular VM way
        - include_role:
            name: validate-host
        - include_role:
            name: prepare-workspace
        - include_role:
            name: add-build-sshkey
      when: "ansible_connection != 'kubectl'"
    - block:
        # A Pod way
        - include_role:
            name: prepare-workspace-openshift
        - include_role:
            name: remove-zuul-sshkey
      run_once: true
      when: "ansible_connection == 'kubectl'"

    - import_role:
        name: ensure-output-dirs
      when: ansible_user_dir is defined

# If job has zuul_vault variable with role_name use it to generate wrapped
# secret-id and leave it at well-known location. The job is then responsible to
# take it and use. Secret is wrapped with ttl set to job timeout
- hosts: localhost
  roles:
    - role: create-vault-approle-secret
      vault_addr: "{{ zuul_vault_addr }}"
      vault_token: "{{ lookup('file', zuul_base_vault_token_path) }}"
      vault_secret_dest: "{{ zuul.executor.work_root }}/.approle-secret"
      vault_role_name: "{{Â zuul_vault.vault_role_name }}"
      when:
        - "zuul.post_review | bool"
        - "zuul_vault_addr is defined"
        - "zuul_base_vault_token_path is defined"
        - "zuul_vault is defined"
        - "zuul_vault.role_name is defined"
